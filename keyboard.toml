# ============================================================
# Cornix HRM keyboard.toml
# ============================================================
# 変更点:
#   1. matrix_map に L/R hand 情報 + positional profiles を追加
#   2. [behavior.morse.profiles] に HRM, HRM_RING, FH を定義
#   3. [behavior.fork] を追加
#   4. [behavior.tri_layer] を追加（Layer 3 = LT1 + LT2）
#   5. base_layer を現在の Vial レイアウトに合わせて MT/LT + profile で記述
#
# ⚠️ 重要: matrix_map の positional profiles は Vial で設定した
#    MT/LT キーにも自動適用される。clear_storage は不要。
# ============================================================

[keyboard]
name = "Cornix"
product_name = "Cornix"
vendor_id = 0x4c4b
product_id = 0x4643
manufacturer = "Jezail Funder"
chip = "nrf52840"

[ble]
enabled = true
ble_use_2m_phy = true
default_tx_power = 0
battery_adc_pin = "P0_05"
adc_divider_measured = 2000
adc_divider_total = 2806

[split]
connection = "ble"

[split.central]
rows = 4
cols = 7
row_offset = 0
col_offset = 0

[split.central.matrix]
row_pins = ["P0_30", "P0_31", "P0_29", "P0_02"]
col_pins = ["P0_28", "P0_03", "P1_10", "P1_11", "P1_13", "P0_09", "P0_10"]

[[split.central.input_device.encoder]]
pin_a = "P1_04"
pin_b = "P1_06"
phase = "resolution"
resolution = 4

[[split.peripheral]]
rows = 4
cols = 7
row_offset = 4
col_offset = 0

[split.peripheral.matrix]
row_pins = ["P1_09", "P0_28", "P0_03", "P1_10"]
col_pins = ["P0_30", "P0_31", "P0_29", "P0_02", "P1_13", "P0_10", "P0_09"]

[[split.peripheral.input_device.encoder]]
pin_a = "P1_04"
pin_b = "P1_06"
phase = "resolution"
resolution = 4

[rmk]
split_peripherals_num = 1
debounce_time = 5
ble_profiles_num = 5
morse_max_num = 32
max_patterns_per_key = 8
combo_max_num = 32
fork_max_num = 16

[host]
vial_enabled = true
unlock_keys = [[1, 3], [1, 4]]

[storage]
enabled = true
# ⚠️ Vial のキーマップを維持するため false のまま。
# keyboard.toml の layer 定義でキーマップをリセットしたい場合は
# 一時的に true にしてビルド → フラッシュ → false に戻して再ビルド。
clear_storage = false
clear_layout = false

[dependency]
defmt_log = false

[chip.nrf52840]
dcdc_reg0 = true
dcdc_reg1 = true
dcdc_reg0_voltage = "3V3"

# ============================================================
# レイアウト — matrix_map に hand + positional profiles
# ============================================================
# L/R: unilateral_tap の「同じ手」判定に使用
# :PROFILE: そのキー位置のデフォルトプロファイル
#           → Vial で設定した MT/LT にも自動適用される
#
# 物理配置:
#   左手 top:    (0,0)  (0,1)  (0,2)  (0,3)  (0,4)  (0,5)
#   右手 top:    (4,5)  (4,4)  (4,3)  (4,2)  (4,1)  (4,0)
#   左手 home:   (1,0)  (1,1)  (1,2)  (1,3)  (1,4)  (1,5)
#   右手 home:   (5,5)  (5,4)  (5,3)  (5,2)  (5,1)  (5,0)
#   左手 bottom: (2,0)  (2,1)  (2,2)  (2,3)  (2,4)  (2,5)  (2,6)
#   右手 bottom: (5,6)  (6,5)  (6,4)  (6,3)  (6,2)  (6,1)  (6,0)
#   左手 thumb:  (3,0)  (3,1)  (3,2)  (3,3)  (3,4)  (3,5)
#   右手 thumb:  (7,5)  (7,4)  (7,3)  (7,2)  (7,1)  (7,0)
# ============================================================
[layout]
rows = 8
cols = 7
layers = 10
matrix_map = """
(0,0,L) (0,1,L) (0,2,L) (0,3,L) (0,4,L) (0,5,L)                   (4,5,R) (4,4,R) (4,3,R) (4,2,R) (4,1,R) (4,0,R)
(1,0,L) (1,1,L) (1,2,L) (1,3,L) (1,4,L) (1,5,L)                   (5,5,R) (5,4,R) (5,3,R) (5,2,R) (5,1,R) (5,0,R)
(2,0,L) (2,1,L) (2,2,L) (2,3,L) (2,4,L) (2,5,L) (2,6,L) (5,6,R)  (6,5,R) (6,4,R) (6,3,R) (6,2,R) (6,1,R) (6,0,R)
(3,0,L) (3,1,L) (3,2,L) (3,3,L) (3,4,L) (3,5,L)                   (7,5,R) (7,4,R) (7,3,R) (7,2,R) (7,1,R) (7,0,R)
"""

# ============================================================
# Layer 0: ベース（現在の Vial レイアウト準拠）
# ============================================================
# ⚠️ clear_storage = false の場合、この定義は Vial ストレージに
#    上書きされる。ただし matrix_map の positional profiles は
#    Vial のキーにも適用されるため、プロファイルは有効。
#
# clear_storage = true でビルドすると、このレイヤー定義が
# 初期キーマップとしてロードされる。
# ============================================================
[[layer]]
name = "base"
keys = """
Tab        Q         W              E             R             T                              Y             U              I               O              P          Quot
LCtrl      A         MT(S, LCtrl, HRM_RING)  MT(D, LAlt, HRM)  MT(F, LGui, HRM)  G                              H             MT(J, RGui, HRM)  MT(K, RAlt, HRM)  MT(L, RCtrl, HRM_RING)  Semicolon  Minus
LShift     Z         X              C             V             B      Mute   NO    N             M              Comma           Dot            Slash      Up
CapsLock   LAlt      LGui           LT(2, Esc, FH)  Space      TH(LANG2, LShift, FH)         TH(LANG1, RShift, FH)  LT(4, Bksp, FH)  LT(1, Enter, FH)  Left           Down       Right
"""
encoders = [["AudioVolDown", "AudioVolUp"], ["MouseWheelDown", "MouseWheelUp"]]

# ============================================================
# Layer 1: 数字 + ナビゲーション（LT1 = Enter hold で有効）
# ============================================================
# Vial で細かく調整済みのため、ここでは簡略版を記載。
# clear_storage = true で反映、その後 Vial で微調整。
# ============================================================
[[layer]]
name = "numbers"
keys = """
_          Kc1       Kc2            Kc3           Kc4           Kc5                            Kc6           Kc7            Kc8             Kc9            Kc0        _
LCtrl      _         LAlt           LCtrl         LGui          _                              _             _              _               _              _          _
LShift     _         _              _             _             _      _      _     _           _              _               _              _          _
_          LAlt      LGui           _             _             _                              _             _              _               _              _          _
"""
encoders = [["_", "_"], ["_", "_"]]

# ============================================================
# Layer 2: 記号 + Vim 移動（LT2 = Esc hold で有効）
# ============================================================
[[layer]]
name = "symbols"
keys = """
_          WM(Kc1, LShift)  WM(Kc2, LShift)  WM(Kc3, LShift)  WM(Kc4, LShift)  WM(Kc5, LShift)      WM(Kc7, LShift)  WM(Kc8, LShift)  _       _      _      _
_          WM(Kc9, LShift)  WM(Kc0, LShift)  LeftBracket       RightBracket      WM(Backslash, LShift)      Left              Down              Up      Right  _      _
LShift     _                WM(RightBracket, LShift)  WM(LeftBracket, LShift)  _  _  _  _  WM(Equal, LShift)  Grave  WM(Minus, LShift)  WM(Backslash, LShift)  RShift  _
_          LAlt             LGui              _                 _                 _                          _                Del               _       _      _      _
"""
encoders = [["_", "_"], ["_", "_"]]

# ============================================================
# Layer 3: Adjust / Tri-Layer（LT1 + LT2 同時で有効）
# ============================================================
# BT 切替、F キー、システム設定を配置
# ============================================================
[[layer]]
name = "adjust"
keys = """
_      F1     F2     F3     F4     F5                 F6     F7     F8     F9     F10    _
_      User0  User1  User2  User3  User4              _      _      _      _      F11    _
_      _      _      _      _      _      _      _    _      _      _      _      F12    _
_      _      _      _      _      _                  _      _      _      _      _      User7
"""
encoders = [["_", "_"], ["_", "_"]]

# ============================================================
# Layer 4: Hyper + アプリ起動（LT4 = Bksp hold で有効）
# ============================================================
# Hyper = Ctrl+Shift+Alt+GUI — Alfred App Shortcuts で受ける
# ============================================================
[[layer]]
name = "hyper"
keys = """
WM(Tab, LCtrl | LShift | LAlt | LGui)   WM(Kc1, LShift | LGui)   WM(Kc2, LShift | LGui)   WM(Kc3, LShift | LGui)   _   _       WM(U, LCtrl | LShift | LAlt | LGui)  WM(I, LCtrl | LShift | LAlt | LGui)  WM(O, LCtrl | LShift | LAlt | LGui)  WM(P, LCtrl | LShift | LAlt | LGui)  F12  _
_  WM(A, LCtrl | LShift | LAlt | LGui)  WM(S, LCtrl | LShift | LAlt | LGui)  _  WM(F, LCtrl | LShift | LAlt | LGui)  _       WM(H, LCtrl | LShift | LAlt | LGui)  WM(J, LCtrl | LShift | LAlt | LGui)  WM(K, LCtrl | LShift | LAlt | LGui)  WM(L, LCtrl | LShift | LAlt | LGui)  F11  _
_  _  _  WM(C, LCtrl | LShift | LAlt | LGui)  _  WM(B, LCtrl | LShift | LAlt | LGui)  _  _  _  _  _  F10  _  _
_  _  _  _  WM(Space, LAlt)  WM(S, LCtrl | LAlt | LGui)                _  _  _  _  User1  User0
"""
encoders = [["AudioVolDown", "AudioVolUp"], ["MouseWheelDown", "MouseWheelUp"]]

# ============================================================
# Layer 5-9: 空レイヤー（Vial で自由に設定可能）
# ============================================================
[[layer]]
name = "layer5"
keys = """
_ _ _ _ _ _       _ _ _ _ _ _
_ _ _ _ _ _       _ _ _ _ _ _
_ _ _ _ _ _ _ _   _ _ _ _ _ _
_ _ _ _ _ _       _ _ _ _ _ _
"""
encoders = [["_", "_"], ["_", "_"]]

[[layer]]
name = "layer6"
keys = """
_ _ _ _ _ _       _ _ _ _ _ _
_ _ _ _ _ _       _ _ _ _ _ _
_ _ _ _ _ _ _ _   _ _ _ _ _ _
_ _ _ _ _ _       _ _ _ _ _ _
"""
encoders = [["_", "_"], ["_", "_"]]

[[layer]]
name = "layer7"
keys = """
_ _ _ _ _ _       _ _ _ _ _ _
_ _ _ _ _ _       _ _ _ _ _ _
_ _ _ _ _ _ _ _   _ _ _ _ _ _
_ _ _ _ _ _       _ _ _ _ _ _
"""
encoders = [["_", "_"], ["_", "_"]]

[[layer]]
name = "layer8"
keys = """
_ _ _ _ _ _       _ _ _ _ _ _
_ _ _ _ _ _       _ _ _ _ _ _
_ _ _ _ _ _ _ _   _ _ _ _ _ _
_ _ _ _ _ _       _ _ _ _ _ _
"""
encoders = [["_", "_"], ["_", "_"]]

[[layer]]
name = "layer9"
keys = """
_ _ _ _ _ _       _ _ _ _ _ _
_ _ _ _ _ _       _ _ _ _ _ _
_ _ _ _ _ _ _ _   _ _ _ _ _ _
_ _ _ _ _ _       _ _ _ _ _ _
"""
encoders = [["_", "_"], ["_", "_"]]

# ============================================================
# Behavior — プロファイル定義
# ============================================================

[behavior.one_shot]
timeout = "3s"

[behavior.combo]
timeout = "50ms"
combos = []

# Tri-Layer: LT1(Enter) + LT2(Esc) 同時押しで Layer 3 (Adjust)
[behavior.tri_layer]
upper = 1
lower = 2
adjust = 3

# ────────────────────────────────────────────────
# Morse / Tap-Hold グローバルデフォルト
# ────────────────────────────────────────────────
# プロファイル未指定かつ matrix_map でも指定なしのキーに適用。
# 通常の MT/LT キー（HRM でないもの）向け。
[behavior.morse]
enable_flow_tap = false
hold_on_other_press = true
hold_timeout = "250ms"
gap_timeout = "250ms"

# ────────────────────────────────────────────────
# プロファイル定義
# ────────────────────────────────────────────────
# 適用優先順位:
#   1. キーマップの MT/LT 第3引数 (最強)
#   2. matrix_map の positional profile
#   3. [behavior.morse] のグローバルデフォルト (最弱)
# ────────────────────────────────────────────────
[behavior.morse.profiles]

# HRM: 人差し指・中指用 Home Row Mod
#   - enable_flow_tap + prior_idle_time: 高速タイピング中の誤Hold防止
#   - permissive_hold: Hold中に別キーtapで即Hold確定
#   - unilateral_tap: 同じ手のキー押下で即tap（matrix_mapのL/Rで判定）
HRM = { enable_flow_tap = true, prior_idle_time = "150ms", permissive_hold = true, unilateral_tap = true, hold_timeout = "280ms", gap_timeout = "280ms" }

# HRM_RING: 薬指用（反応が遅いため hold_timeout を長めに）
HRM_RING = { enable_flow_tap = true, prior_idle_time = "150ms", permissive_hold = true, unilateral_tap = true, hold_timeout = "300ms", gap_timeout = "300ms" }

# FH: 親指キー用（Layer Tap / Shift-LANG 切替）
#   - hold_on_other_press: 他キー押下で即Hold（Shift/Layerは遅延なく効いてほしい）
#   - unilateral_tap 不要（親指は bilateral の問題がない）
FH = { hold_on_other_press = true, hold_timeout = "200ms", gap_timeout = "200ms" }

# ────────────────────────────────────────────────
# Fork — 修飾キー状態で出力を切り替え
# ────────────────────────────────────────────────
# ⚠️ trigger はキーマップに記載された通りのキーを指定。
#    LT(2, Backspace) がキーマップにある場合、
#    trigger = "Backspace" では動作しない。
# ────────────────────────────────────────────────
[behavior.fork]
forks = [
    # Shift + . で : を出力（Vim コマンド、時刻入力に便利）
    { trigger = "Dot", negative_output = "Dot", positive_output = "WM(Semicolon, LShift)", match_any = "LShift|RShift" },
    # Shift + , で ; を出力（プログラミングで頻出）
    { trigger = "Comma", negative_output = "Comma", positive_output = "Semicolon", match_any = "LShift|RShift" },
]