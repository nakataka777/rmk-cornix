# ============================================================
# Cornix HRM keyboard.toml
# ============================================================
# ビルド確認済み: rmk v0.8.2 / rmk-macro v0.7.1
#
# プロファイル適用の優先順位（ソースコード確認済み）:
#   1. MT/LT/TH の第3引数（最強）
#   2. [behavior.morse] のグローバルデフォルト（フォールバック）
#
# ⚠️ matrix_map は (row,col,hand?) のみ。:PROFILE 構文は存在しない。
# ⚠️ Vial の 16bit キーコードにプロファイル情報は格納されない。
#    Vial で HRM キーを編集すると書き戻し時にプロファイルが消える。
#    → Layer 0 の HRM/親指キーは Vial で触らないこと。
# ============================================================

[keyboard]
name = "Cornix"
product_name = "Cornix"
vendor_id = 0x4c4b
product_id = 0x4643
manufacturer = "Jezail Funder"
chip = "nrf52840"

[ble]
enabled = true
ble_use_2m_phy = true
default_tx_power = 0
battery_adc_pin = "P0_05"
adc_divider_measured = 2000
adc_divider_total = 2806

[split]
connection = "ble"

[split.central]
rows = 4
cols = 7
row_offset = 0
col_offset = 0

[split.central.matrix]
row_pins = ["P0_30", "P0_31", "P0_29", "P0_02"]
col_pins = ["P0_28", "P0_03", "P1_10", "P1_11", "P1_13", "P0_09", "P0_10"]

[[split.central.input_device.encoder]]
pin_a = "P1_04"
pin_b = "P1_06"
phase = "resolution"
resolution = 4

[[split.peripheral]]
rows = 4
cols = 7
row_offset = 4
col_offset = 0

[split.peripheral.matrix]
row_pins = ["P1_09", "P0_28", "P0_03", "P1_10"]
col_pins = ["P0_30", "P0_31", "P0_29", "P0_02", "P1_13", "P0_10", "P0_09"]

[[split.peripheral.input_device.encoder]]
pin_a = "P1_04"
pin_b = "P1_06"
phase = "resolution"
resolution = 4

[rmk]
split_peripherals_num = 1
debounce_time = 5
ble_profiles_num = 5
morse_max_num = 32
max_patterns_per_key = 8
combo_max_num = 32
fork_max_num = 16

[host]
vial_enabled = true
unlock_keys = [[1, 3], [1, 4]]

[storage]
enabled = true
# clear_storage の動作（storage/mod.rs で確認済み）:
#   false → Vial ストレージが優先。keyboard.toml のレイヤー定義は無視。
#   true  → erase_all() でストレージ消去 → keyboard.toml のレイヤー定義をロード。
#
# ストレージに関係なく常に有効:
#   - [behavior.morse.profiles] — コンパイル時にコード生成
#   - [behavior.fork], [behavior.tri_layer] — ランタイムロジック
#   - matrix_map の L/R hand — unilateral_tap の判定
#
# 初回フラッシュ手順:
#   1. clear_storage = true でビルド → フラッシュ → Layer 0 のプロファイルがロード
#   2. Vial で Layer 1〜4 を再設定（Layer 0 の HRM/親指キーは触らない）
#   3. clear_storage = false に戻してビルド → フラッシュ → 以降 Vial 設定が維持
clear_storage = false
clear_layout = false

[dependency]
defmt_log = false

[chip.nrf52840]
dcdc_reg0 = true
dcdc_reg1 = true
dcdc_reg0_voltage = "3V3"

# ============================================================
# レイアウト — matrix_map に L/R hand 情報
# ============================================================
# 文法: (row,col,hand?) — hand は L/R/* のみ（keymap.pest で確認済み）
# L/R: unilateral_tap の「同じ手」判定に使用
# ============================================================
[layout]
rows = 8
cols = 7
layers = 10
matrix_map = """
(0,0,L) (0,1,L) (0,2,L) (0,3,L) (0,4,L) (0,5,L)                   (4,5,R) (4,4,R) (4,3,R) (4,2,R) (4,1,R) (4,0,R)
(1,0,L) (1,1,L) (1,2,L) (1,3,L) (1,4,L) (1,5,L)                   (5,5,R) (5,4,R) (5,3,R) (5,2,R) (5,1,R) (5,0,R)
(2,0,L) (2,1,L) (2,2,L) (2,3,L) (2,4,L) (2,5,L) (2,6,L) (5,6,R)  (6,5,R) (6,4,R) (6,3,R) (6,2,R) (6,1,R) (6,0,R)
(3,0,L) (3,1,L) (3,2,L) (3,3,L) (3,4,L) (3,5,L)                   (7,5,R) (7,4,R) (7,3,R) (7,2,R) (7,1,R) (7,0,R)
"""

# ============================================================
# Layer 0: ベース（現在の Vial レイアウト準拠）
# ============================================================
# プロファイルは MT/LT/TH の第3引数で直接指定。
# Vial で HRM/親指キーを編集するとプロファイルが消える（16bit変換時に欠落）。
# → S,D,F,J,K,L と Esc,Bksp,Enter,LANG切替 は Vial で触らないこと。
# ============================================================
[[layer]]
name = "base"
keys = """
Tab        Q         W              E             R             T                              Y             U              I               O              P          Quot
LCtrl      A         MT(S, LCtrl, HRM_RING)  MT(D, LAlt, HRM)  MT(F, LGui, HRM)  G                              H             MT(J, RGui, HRM)  MT(K, RAlt, HRM)  MT(L, RCtrl, HRM_RING)  Semicolon  Minus
LShift     Z         X              C             V             B      Mute   NO    N             M              Comma           Dot            Slash      Up
CapsLock   LAlt      LGui           LT(2, Esc, FH)  Space      MT(Language2, LShift, FH)         MT(Language1, RShift, FH)  LT(4, Backspace, FH)  LT(1, Enter, FH)  Left           Down       Right
"""
encoders = [["AudioVolDown", "AudioVolUp"], ["MouseWheelDown", "MouseWheelUp"]]

[[layer]]
name = "numbers"
keys = """
_          Kc1       Kc2            Kc3           Kc4           Kc5                            Kc6           Kc7            Kc8             Kc9            Kc0        _
LCtrl      _         LAlt           LCtrl         LGui          _                              _             _              _               _              _          _
LShift     _         _              _             _             _      _      _     _           _              _               _              _          _
_          LAlt      LGui           _             _             _                              _             _              _               _              _          _
"""
encoders = [["_", "_"], ["_", "_"]]

[[layer]]
name = "symbols"
keys = """
_          WM(Kc1, LShift)  WM(Kc2, LShift)  WM(Kc3, LShift)  WM(Kc4, LShift)  WM(Kc5, LShift)      WM(Kc7, LShift)  WM(Kc8, LShift)  _       _      _      _
_          WM(Kc9, LShift)  WM(Kc0, LShift)  LeftBracket       RightBracket      WM(Backslash, LShift)      Left              Down              Up      Right  _      _
LShift     _                WM(RightBracket, LShift)  WM(LeftBracket, LShift)  _  _  _  _  WM(Equal, LShift)  Grave  WM(Minus, LShift)  WM(Backslash, LShift)  RShift  _
_          LAlt             LGui              _                 _                 _                          _                Del               _       _      _      _
"""
encoders = [["_", "_"], ["_", "_"]]

[[layer]]
name = "adjust"
keys = """
_      F1     F2     F3     F4     F5                 F6     F7     F8     F9     F10    _
_      User0  User1  User2  User3  User4              _      _      _      _      F11    _
_      _      _      _      _      _      _      _    _      _      _      _      F12    _
_      _      _      _      _      _                  _      _      _      _      _      User7
"""
encoders = [["_", "_"], ["_", "_"]]

[[layer]]
name = "hyper"
keys = """
WM(Tab, LCtrl | LShift | LAlt | LGui)   WM(Kc1, LShift | LGui)   WM(Kc2, LShift | LGui)   WM(Kc3, LShift | LGui)   _   _       WM(U, LCtrl | LShift | LAlt | LGui)  WM(I, LCtrl | LShift | LAlt | LGui)  WM(O, LCtrl | LShift | LAlt | LGui)  WM(P, LCtrl | LShift | LAlt | LGui)  F12  _
_  WM(A, LCtrl | LShift | LAlt | LGui)  WM(S, LCtrl | LShift | LAlt | LGui)  _  WM(F, LCtrl | LShift | LAlt | LGui)  _       WM(H, LCtrl | LShift | LAlt | LGui)  WM(J, LCtrl | LShift | LAlt | LGui)  WM(K, LCtrl | LShift | LAlt | LGui)  WM(L, LCtrl | LShift | LAlt | LGui)  F11  _
_  _  _  WM(C, LCtrl | LShift | LAlt | LGui)  _  WM(B, LCtrl | LShift | LAlt | LGui)  _  _  _  _  _  F10  _  _
_  _  _  _  WM(Space, LAlt)  WM(S, LCtrl | LAlt | LGui)                _  _  _  _  User1  User0
"""
encoders = [["AudioVolDown", "AudioVolUp"], ["MouseWheelDown", "MouseWheelUp"]]

[[layer]]
name = "layer5"
keys = """
_ _ _ _ _ _       _ _ _ _ _ _
_ _ _ _ _ _       _ _ _ _ _ _
_ _ _ _ _ _ _ _   _ _ _ _ _ _
_ _ _ _ _ _       _ _ _ _ _ _
"""
encoders = [["_", "_"], ["_", "_"]]

[[layer]]
name = "layer6"
keys = """
_ _ _ _ _ _       _ _ _ _ _ _
_ _ _ _ _ _       _ _ _ _ _ _
_ _ _ _ _ _ _ _   _ _ _ _ _ _
_ _ _ _ _ _       _ _ _ _ _ _
"""
encoders = [["_", "_"], ["_", "_"]]

[[layer]]
name = "layer7"
keys = """
_ _ _ _ _ _       _ _ _ _ _ _
_ _ _ _ _ _       _ _ _ _ _ _
_ _ _ _ _ _ _ _   _ _ _ _ _ _
_ _ _ _ _ _       _ _ _ _ _ _
"""
encoders = [["_", "_"], ["_", "_"]]

[[layer]]
name = "layer8"
keys = """
_ _ _ _ _ _       _ _ _ _ _ _
_ _ _ _ _ _       _ _ _ _ _ _
_ _ _ _ _ _ _ _   _ _ _ _ _ _
_ _ _ _ _ _       _ _ _ _ _ _
"""
encoders = [["_", "_"], ["_", "_"]]

[[layer]]
name = "layer9"
keys = """
_ _ _ _ _ _       _ _ _ _ _ _
_ _ _ _ _ _       _ _ _ _ _ _
_ _ _ _ _ _ _ _   _ _ _ _ _ _
_ _ _ _ _ _       _ _ _ _ _ _
"""
encoders = [["_", "_"], ["_", "_"]]

# ============================================================
# Behavior
# ============================================================

[behavior.one_shot]
timeout = "3s"

[behavior.combo]
timeout = "50ms"
combos = []

[behavior.tri_layer]
upper = 1
lower = 2
adjust = 3

# グローバルデフォルト（プロファイル未指定のキーに適用）
[behavior.morse]
enable_flow_tap = false
hold_on_other_press = true
hold_timeout = "250ms"
gap_timeout = "250ms"

# プロファイル定義
[behavior.morse.profiles]

# HRM: 人差し指・中指用
HRM = { enable_flow_tap = true, prior_idle_time = "100ms", permissive_hold = true, unilateral_tap = true, hold_timeout = "280ms", gap_timeout = "280ms" }

# HRM_RING: 薬指用（hold_timeout 長め）
HRM_RING = { enable_flow_tap = true, prior_idle_time = "100ms", permissive_hold = true, unilateral_tap = true, hold_timeout = "300ms", gap_timeout = "300ms" }

# FH: 親指キー用（即 hold 判定）
FH = { hold_on_other_press = true, hold_timeout = "200ms", gap_timeout = "200ms" }

# Fork
[behavior.fork]
forks = [
    { trigger = "Dot", negative_output = "Dot", positive_output = "WM(Semicolon, LShift)", match_any = "LShift|RShift" },
    { trigger = "Comma", negative_output = "Comma", positive_output = "Semicolon", match_any = "LShift|RShift" },
]
